<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>title</title>
</head>
<body>
  <h1>Now Playing: <span id="track-name">None</span></h1>

  <button id="pickFolderBtn">Pick Folder</button>
  <br><br>

  <label for="volumeSlider">Volume:</label>
  <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" />

  <br><br>
  <button id="startButton" disabled>Start Playlist</button>

  <script>
    let audioFiles = [];
    let currentTrack = 0;
    const audio = new Audio();
    const trackNameSpan = document.getElementById('track-name');
    let outputPath = ''

    // Volume control
    const volumeSlider = document.getElementById('volumeSlider');
    audio.volume = volumeSlider.value;
    volumeSlider.addEventListener('input', () => {
      audio.volume = volumeSlider.value;
    });

    // Step 1: User picks a folder, read .m4a files
    document.getElementById('pickFolderBtn').addEventListener('click', async () => {
      audioFiles = [];
      currentTrack = 0;

      try {
        const dirHandle = await window.showDirectoryPicker();

        // Iterate entries in the directory
        for await (const [name, handle] of dirHandle.entries()) {
          if (handle.kind === 'file' && name.endsWith('.m4a')) {
            const file = await handle.getFile();
            audioFiles.push({
              name: file.name,
              url: URL.createObjectURL(file)
            });
          } else if (name === 'now playing.txt') {
            outputPath = await dirHandle.getFileHandle(name, { create: true });
          }
        }

        if (audioFiles.length > 0) {
          document.getElementById('startButton').disabled = false;
          trackNameSpan.textContent = `Ready: ${audioFiles.length} file(s)`;
        } else {
          trackNameSpan.textContent = 'No .m4a files found in folder.';
          document.getElementById('startButton').disabled = true;
        }
      } catch (err) {
        console.error('Folder pick cancelled or failed', err);
        trackNameSpan.textContent = 'No folder selected.';
        document.getElementById('startButton').disabled = true;
      }
    });

    async function writeToFile(name, fileHandle = outputPath) {
    try {
        const writable = await fileHandle.createWritable();
        await writable.write(name);
        await writable.close();
        trackNameSpan.textContent = name
        console.log(`Wrote "${name}" to file.`);
    } catch (err) {
        console.error('Failed to write file:', err);
    }
    }

    // Step 2: Play audio files in a loop
    function playNext() {
      const track = audioFiles[currentTrack];
      audio.src = track.url;
      writeToFile(track.name)
      audio.play();
      currentTrack = (currentTrack + 1) % audioFiles.length;
    }

    audio.addEventListener('ended', playNext);

    // Step 3: Start playlist on button click
    document.getElementById('startButton').addEventListener('click', () => {
      if (audioFiles.length > 0) {
        currentTrack = 0;
        playNext();
      }
    });
  </script>
</body>
</html>